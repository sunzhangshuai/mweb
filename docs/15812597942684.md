# 数据恢复

## 误删行
1. 恢复出一个备份，或者找一个从库作为临时库，
2. 在这个临时库上执行这些操作，然后再将确认过的临时库的数据，恢复回主库。
        
        单个事务恢复：
        1. insert 语句，对应的 binlog event 类型是 Write_rows event，把它改成 Delete_rows event
        2. delete 语句，将 Delete_rows event 改为 Write_rows event
        3.Update_rows语句，binlog 里面记录了数据行修改前和修改后的值，对调这两行的位置即可
        
        
    ```
    多个事务恢复：
    将事务的顺序调过来再执行。
    ```

### 预防措施
1. 把 sql_safe_updates 参数设置为 on。如果忘记在 delete，update 语句中写 where 条件，或者 where 条件里面没有包含索引字段，这条语句的执行就会报错。
2. 代码上线前，必须经过 SQL 审计。

## 误删库/表
- drop database
- drop table table_name
- truncate table table_name

### 恢复流程
        
    方法一：
    1. 取最近一次全量备份，假设这个库是一天一备，上次备份是当天 0 点；
    2. 用备份恢复出一个临时库；从日志备份里面，取出凌晨 0 点之后的日志；
    3. 把这些日志，除了误删除数据的语句外，全部应用到临时库。

```
加速1：
1. 在用备份恢复出临时实例之后，将这个临时实例设置成线上备库的从库，
2. 在 start slave 之前，先通过执行﻿﻿change replication filter replicate_do_table = (tbl_name) 命令，就可以让临时库只同步误操作的表；
3. 这样做也可以用上并行复制技术，来加速整个数据恢复过程
```
    
```
加速2：
延迟复制备库，通过 CHANGE MASTER TO MASTER_DELAY = N 命令，可以指定这个备库持续保持跟主库有 N 秒的延迟。
```       
     
### 预防措施
1. 账号分离。这样做的目的是，避免写错命令
    - 我们只给业务开发同学 DML 权限，而不给 truncate/drop 权限。而如果业务开发人员有 DDL 需求的话，也可以通过开发管理系统得到支持
    - 即使是 DBA 团队成员，日常也都规定只使用只读账号，必要的时候才使用有更新权限的账号
1. 制定操作规范
    - 在删除数据表之前，必须先对表做改名操作。然后，观察一段时间，确保对业务无影响以后再删除这张表
    - 改表名的时候，要求给表名加固定的后缀（比如加 _to_be_deleted)，然后删除表的动作必须通过管理系统执行。并且，管理系删除表的时候，只能删除固定后缀的表

## rm删除 
只要不是恶意地把整个集群删除，而只是删掉了其中某一个节点的数据的话，HA 系统就会开始工作，选出一个新的主库，从而保证整个集群的正常工作

### 预防
尽量把你的备份跨机房，或者最好是跨城市保存