# 压缩列表「ziplist」

## 应用
列表键中只包含少量元素，并且元素都是小整数值或短的字符串。redis用压缩列表实现。

## 构成
zlbytes | zltail | zllen | entry1 | entry2 | ... | zlend
:--:| :-: | :-: | :--:| :-: | :-: | :-:

- zlbytes：unit32_t，记录占用字节数，内存重分配，计算zlend时使用。
- zltail：unit32_t，记录表尾节点到起始地址的字节数。通过这个偏移量，直接找到尾节点。
- zllen：unit16_t，节点数量，最多2的16次方，节点数大于2的16次方时，需要遍历计算得到。
- entry：压缩列表节点。
- zlend：1字节，存255，用于标记结束。

## 压缩列表节点

### 成员
每个节点可以保存一个字节数组或者一个整数值。
- 字节数组：以下任意一种

        1. 长度小于等于2的6次方-1；
        2. 长度小于等于2的14次方-1；
        3. 长度小于等于2的32次方-1；
- 整数值：以下任意一种

        1. 4位长：0~12无符号整数
        2. 1字节长的有符号整数
        3. 3字节长的有符号整数
        4. int16_t类型整数
        5. int32_t类型整数
        6. int64_t类型整数
        
## 组成
每个节点由previous_entry_length、encoding、content三个部分组成。

- previous_entry_length

        1. 以字节为单位，记录前一个节点的字节长度。
        2. 前一节点长度小于254，previous_entry_length长度为1字节。
        3. 前一节点长度大于254，previous_entry_length长度为5字节，第一个字节存254，标识是5个字节存长度，后四个字节存长度。
        4. 用于从表尾向表头遍历。
- encoding

        1. 1、2、5字节，开头00、01、10，表示存的字节数组，数组的长度由除去最高两位的其他位确定。
        2. 1字节，开头11表示存储整数，整数的类型由除去最高两位的其他位确定。
- content
    
        存储节点的值。
        
## 连锁更新
多个连续的，长度介于250字节到253字节之间的节点。
其中一个节点字符串变长，会导致后面的previous_entry_length连锁更新。
1. 增加节点和删除节点都有可能发生。
2. 出现概率不高。
3. 即使出现，更新的数量也不会很多。

## API
函数 | 作用 | 时间复杂度
:-- | :-- | :--
ziplistNew | 创建压缩列表 | O(1)
ziplistPush | 将新节点添加到表头或表尾 | O(n)，最坏O(n2)，连锁更新。
ziplistInsert | 将新节点添加到给定节点之后 | O(n)，最坏O(n2)，连锁更新。
ziplistIndex | 返回压缩列表给定索引上的节点 | O(n)
ziplistFind | 查找并返回给定值的节点 | O(n2)，字符串匹配
ziplistNext | 返回给定节点的下一个节点 | O(1)
ziplistPrev | 返回给定节点的上一个节点 | O(1)
ziplistGet | 获取给定节点保存的值 | O(1)
ziplistDelete | 删除指定节点 | O(n)，最坏O(n2)，连锁更新。
ziplistDeleteRange | 删除范围节点 | O(n)，最坏O(n2)，连锁更新。
ziplistLen | 返回压缩列表目前的元素个数 |  O(1)
ziplistBlobLen | 返回压缩列表目前占用的内存字节数 | O(1)