# 表级锁
## 表锁
### 作用
一般是在数据库引擎不支持行锁的时候才会被用到。

### 加锁
lock tables ... read/write

### 释放锁
1. unlock tables
2. 客户端断开连接

### 加锁规则
- 读锁
    
        所有线程的写会被阻塞；
        
- 写锁

        其他线程的读写会被阻塞；
        本线程可读写。
        
## 元数据锁【metadata lock】

### 作用
保证读写的正确性。

### 加锁
不需要显式使用，在访问一个表的时候会被自动加上。
- 增删改查时会加读锁；
- 对表做结构变更操作加写锁；

### 释放锁
事务提交的时候

### 加锁规则
- 读锁之间不互斥
- 读写，写锁之间互斥
- 特殊注意事项：对于mdl来说，一旦出现写锁等待，不止限制当前的线程，之后对该表的所有读操作也会被阻塞。

### 给小表加字段
1. 事务要尽可能小。
2. 如果是热点表：在执行时，设置锁等待时间：alter table tb_name wait n ...，避免写锁长时间阻塞进程。

### 问题：从库做全量备份时，主库DDL会发生什么？
分情况：
1. 数据库没有生成建表语句前到达，没有影响。同步的数据是表结构修改后的。
2. 生成建表语句，还没开始查询，进行查询时，会发生备份报错终止。
3. 进行查询时到达，同步阻塞。同步的数据是表结构修改前的。
4. 核心，在全量备份时，元数据锁是在一张表备份完成后主动释放的。
    