# 从请求到返回的流程
1. 请求到达。
2. 处理并解析请求头
3. 确定要处理请求的server配置块。
4. 请求处理：11步。
5. 生成相应（可能需要和上游服务通信）。
6. 过滤返回值。
7. 返回报文。

## 处理并解析请求头
1. 客户端和操作系统三次握手。
2. 事件epoll_wait监听到连接建立时，会在连接内存池中分配出一块儿空间，每次分配的大小是521b。
3. http模块添加定时器，client_header_timeout:60s，意味着握手后，如果60s内还没有header请求，就失效了，要进行断开，销毁内存。
4. 客户端发送data数据。
5. 对于接收到的数据，服务器还要从连接内存池中再分配出1k【client_header_buffer_size】的空间。原因是这些数据只是字节流，还没有进行解析，只能先暂存，暂存的这部分空间就是client_header_buffer_size。
6. 状态机从请求内存池中分配一块儿4k【request_pool_size】内存，然后client_header_buffer中从解析请求行，解析的过程中就可以判断预分配的空间是否足够，不够的话可以扩容，每次分8k，分4次开辟【large_client_header_buffers:4 8k】。
7. 在内存中加上url已结束的标识，继续解析header，内存不足的话，还是按照和请求行的方式一样分配。然后加上header结束的标识。请求行和header使用的是同一区间内存。
8. 请求解析完成后，移除超时定时器。
9. 开始11个阶段的http请求处理。

## 确定server块配置
通过listen和server_name配置确定。

### listen
- 确定请求的ip地址【必须请求指定ip】和端口。
- 主要是端口。

### server_name
server_name：后面可以跟多个域名，第一个是主域名

### 主域名
- 结合指令server_name_in_redirect使用。
- server_name_in_redirect默认值为off。
- 当设置为on时，如果在本服务器内发生重定向，返回给客户端的应答头的location会返回主域名。

### 域名

#### 正则表达式
- 域名前加~
- 可以用()获取变量，默认$1、2、3。
- 可以用(?<变量名>表达式)的方式来指定变量名。

#### 泛域名
1. .sss.com => ss.com || *.ss.com。
2. ss. => ss.*
3. _ 匹配所有域名。
4. "" 匹配没有传host头部的域名。

### 匹配顺序
1. 精确匹配
2. 后缀匹配，*在前
3. 前缀匹配，*在后
4. 按文件中的顺序匹配正则表达式。
5. default server
    1. 没有就是第一个server。
    2. 或者listen指定了default。