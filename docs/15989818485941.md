# 字符串结构
```
struct _zend_string {
	zend_refcounted_h gc;              /* 8字节，内嵌的gc引用计数及字符串类别存储 */
	zend_ulong        h;               /* hash值，8字节，字符串的hash值 */
	size_t            len;             /* 8字节，字符串的长度 */
	char              val[1];          /* 柔性数数组，占1字节，字符串的值存储位置 */
};
```

## gc字段
主要作用是存放引用计数等。

```
typedef struct _zend_refcounted_h {
	uint32_t         refcount;			/* 4字节，引用计数的值存储 */
	union {                            /* 4字节 */ 
		struct {
			ZEND_ENDIAN_LOHI_3(
				zend_uchar    type,     /* 等同于zval的u1.v.type */
				zend_uchar    flags,    /* 字符串的类型数据 */
				uint16_t      gc_info)  /* 垃圾回收标识颜色 */
		} v;
		uint32_t type_info;
	} u;
} zend_refcounted_h;
```
```
define ZEND_ENDIAN_LOHI_3(lo, mi, hi)    hi; mi; lo;
```
- 引用计数存放在refcount字段。
- 类别信息存储在flags字段。
- 字符串所属的变量类别存储在type字段。

## h字段
缓存字符串的哈希值，只有当字符串需要被作为数组key时才会初始化，同一个字符串被多次当作key使用时，不会重复计算其对应的哈希值。

## val字段
存储字符串值。
char[1]称为柔性数组，当结构体中仅有一个变长的字符串且为最后一个字段时，就可采用这种实现方式。

### 柔性数组的优势
- 分配字符串内存时，一次申请的内存大小不仅仅是结构体的大小，还要额外加上字符串值的长度len+1。`*zend_string_alloc函数`。
- 柔性数组val字段占用了末尾连续的一块内存，用于存储不定长度的字符串值。
- struct中字符串的值与其他成员便存储在同一块连续的空间中，在分配、释放内存时便可将struct当成整体处理。
- 读写字符串值时可以省一次内存读写。
- PHP 7采用val[1]而不用val[]占位是为了兼容不同版本的C编译器。

## len字段
类型是size_t（long unsigned int）。
- 时间换空间的做法，直接记录以避免重复计算字符串的长度。
- 保证了PHP字符串操作`二进制安全`。

### 二进制安全
数据在写入时是什么样的，它被读取时就是什么样，这种能力称为字符串的二进制安全。
- C字符串中的字符必须符合某种编码（比如ASCII），并且除了字符串的末尾之外，字符串里面不能包含“\0”（空字符），否则字符串中的“\0”将被误认为是字符串结束符。
    - 限制使得C字符串只能保存文本数据，而不能保存像图片、音频、视频、压缩文件这样的二进制数据。
- PHP在处理带二进制字符的字符串时，程序不会对其中的数据做任何限制、过滤或者假设。

```
$a = 'aaa\0b';
$b = 'aaa\0c';
在C语言中认为这两个字符串长度均为3，是一样的。
在php中认为这两个字符串不一样，长度均为5。
```
