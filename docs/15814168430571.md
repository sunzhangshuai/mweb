# kill

## 线程
- mysql的线程上限由参数innodb_thread_concurrency控制。

## kill query 线程id
- 含义：终止线程中正在执行的语句 
- 执行流程 
    1. 把线程的运行状态改成 THD::KILL_QUERY(将变量 killed 赋值为 THD::KILL_QUERY)；
    2. 给执行线程发一个信号
      
- kill不掉的情况
    1. 线程没有执行到判断线程状态的逻辑。
        
            锁等待可以判断线程状态；
            线程超出上限等待时无法判断线程状态。
    2. 终止逻辑耗时较长：
        - 超大事务执行期间被 kill：回滚操作耗时很长。
        - 大查询回滚：查询过程中生成了比较大的临时文件，删除临时文件可能需要等待 IO 资源，导致耗时较长。
        - DDL 命令执行到最后阶段：需要删除中间过程的临时文件，也可能受 IO 资源影响耗时较久
  
## kill [connection] 线程id
- 含义：断开线程的连接


## 关于客户端的两个误解
1. 如果库里面的表特别多，连接就会很慢。

        实际情况：
        每个客户端在和服务端建立连接的时候，需要做的事情就是 TCP 握手、用户校验、获取权限。跟库里面表的个数无关。

    ```
    慢的原因：     
    使用默认参数连接，客户端提供本地库名和表名补全的功能。为了实现这个功能，客户端在连接成功后，需要多做一些操作：
    1. 执行 show databases；
    2. 切到 db1 库，执行 show tables；
    3. 把这两个命令的结果用于构建一个本地的哈希表。
    所以，是建哈希表慢。即客户端慢。 
    ```
    
    ```
    解决办法：
    加参数 -A 或 -quick
    ```

1. –quick可以让服务器加速
    
        实际情况
        1. 可以关掉客户端自动补全。
        2. 接收服务端返回结果使用不缓存的方式。会让服务端变慢。
        3. 是让客户端变快。
