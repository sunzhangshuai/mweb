# binlog

## 作用
记录数据库的修改记录。
可用于数据备份、数据恢复、主从同步。

## 容量

```
每个binlog文件默认500M。
- 由于命令的执行、系统重启等原因，binlog日志不满500MB就不再写入。
- 执行大事务，不断写入binlog导致当前binlog文件尺寸超过500MB。
```

## 存储位置
由参数log-bin控制

## 记录时机
- 由参数sql_log_bin控制，默认on。
- 作为主库时，在执行DDL或DML语句时记录。
- 作为备库时，读到主库传来的binlog后，写到本地文件，称为中转日志「relay log」。解析出日志里的命令，并执行时记录。

### 记录过程
1. 事务过程中，日志写入binlog cache中。
2. 事务提交时，将日志writ到文件系统的 page cache
3. 根据参数sync_binlog配置，决定持久化到磁盘的频率。

## 日志录入格式
由参数binlog_format控制。

日志中的公共字段含义：

```
SET @@SESSION.GTID_NEXT：指定事务特有的id，用于主备同步时跳过冲突。
server_id：服务器id，由参数server-id控制。
end_log_pos：事务结束位置。
thread_id：线程id
Xid：两阶段提交，恢复数据时，验证redo log有效性。
```

### statement
- 含义：记录sql语句的原文
- 优点：不需要记录每一行的变化，减少了binlog的日志量，占用空间小，节约IO
- 缺点：
    - 主从情况下可能会造成数据不一致。
        - limit操作时可能主从使用不用的索引
    - 不能用于数据恢复。
- 特有字段：
    - SET INSERT_ID=XX：线程需要用到自增值的时候，固定用XX。

### row
- 含义：记录每行数据的变化过程，参数binlog_row_image控制要记录的字段：
    - FULL(默认)：所有字段
    - MINIMAL：必要字段
- 优点：
    - 可以用于数据恢复、备份。
    - 避免主从（备）数据不一致
        - mysql复制。
        - 自增锁申请完立马释放时。 
- 缺点：
    - 记录的日志量大，耗费IO资源，影响执行速度，当update修改多条记录。

### mixed
- 含义：mysql自己判断sql否可能引起主备不一致，如果有可能，就用 row 格式，否则就用 statement 格式。
- 优点：避免语句歧义，节省IO。
- 缺点：无法恢复数据。

## 生成规则
- 判断是否超过6小时
    - 超过：切换到下一号文件，老文件异步上传。
    - 不超过：判断是否超过500MB。
        - 超过：切换到下一号文件，老文件异步上传。
        - 不超过：继续写入。
- 重启切换到下一号文件。

## 保存及清理规则
- 实例使用空间 VS 购买空间
    - 小于80%：看binlog产生时间
        - 小于18小时：实例中保存。
        - 大于18小时：只保存购买空间的30%的binlog「即使该binlog文件已经上传到OSS内」
    - 大于80%：binlog会上传到OSS，发起删除本地数据的请求，本地删除会有任务调度，有一定延迟。

## 命令
1. mysqlbinglog 
    
        --start-position: 指定从哪个位置开始
        -vv: 把内容都解析出来
2. 数据恢复命令
        mysqlbinlog master.000001  --start-position=2738 --stop-position=2973 | mysql -h127.0.0.1 -P13000 -u$user -p$pwd;
